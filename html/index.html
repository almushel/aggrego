<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Aggrego: A Feed Aggregator</title>
  </head>
  <body>
		<h1>Aggrego</h1>
		<div id="logged-out">
			<label for="name-input">Create User:</label>
			<input id="name-input"/>
			<button onclick="createUser()">Create</button>

			<label for="apikey-input">Login with API Key</label>
			<input id="apikey-input"/>
			<button onclick="loginWithKeyInput()">Login</button>
		</div>

		<div id="logged-in" style="display:none">
			<h2 id="current-user">Current user:</h2>
			<button onclick="logout()">Logout</button>
			
			<h2>Posts</h2>
			<button onclick="lsGetPosts()">Refresh</button>
			<div id="posts-container">
			</div>
		</div>

		<script>
			const lsKeyName = "aggrego-apikey"

			async function createUser() {
				const nameInput = document.querySelector("#name-input");

				const requestBody = {
					name: nameInput.value
				};

				const response = await fetch("/v1/users", {
					headers: {
						"Content-Type": "application/json"
					},
					method: "POST",
					body: JSON.stringify(requestBody)
				});

				const rBody = await response.json();

				const success = await login(rBody.apikey);
				if (success) {
					localStorage.setItem(lsKeyName, rBody.apikey);
					nameInput.value = "";
				}
			}
			

			async function login(apikey) {
				const response = await fetch("/v1/users", {
					method: "GET",
					headers: {
						"Authorization": "ApiKey "+apikey
					},
				})
				if (!response.ok) {
					return false;
				}

				const rBody = await response.json();

				document.getElementById("current-user").innerText = "Current user: " + rBody.name;
				document.getElementById("logged-in").style.display = "block";

				document.getElementById("logged-out").style.display = "none";

				getPosts(apikey)

				return true;
			}

			async function loginWithKeyInput() {
				const keyInput = document.getElementById("apikey-input");

				const success = await login(keyInput.value)
				if (success) {
					localStorage.setItem(lsKeyName, keyInput.value)
					keyInput.value = ""
				}
			}

			function logout() {
				localStorage.removeItem(lsKeyName)

				document.getElementById("logged-in").style.display = "none";
				document.getElementById("logged-out").style.display = "block";
			}

			async function getPosts(apikey) {
				const offset = 0;
				const limit = 25;

				const response = await fetch(`/v1/posts?offset=${offset}&limit=${limit}`, {
					method: "GET",
					headers: {
						"Authorization": "ApiKey "+apikey
					}
				});
				const container = document.getElementById("posts-container")
				container.textContent = ""
				const responseBody = await response.json();
				
				for (let post of responseBody) {
					const postElement = document.createElement("div")
					const title = document.createElement("h3");
					title.innerText = post.title;
					const url = document.createElement("a");
					url.href=post.url;
					// NOTE: HTML entities like &rsquo; not parsed correctly
					const description = document.createElement("p");
					description.innerText = post.description;

					url.append(title)
					postElement.append(url, description)
					container.append(postElement)
				}
			}
			
			async function lsLogin() {
				const apikey = localStorage.getItem(lsKeyName)
				if (apikey == null) {
					return false;
				}
				login(apikey)
			}
			
			async function lsGetPosts() {
				const apikey = localStorage.getItem(lsKeyName)
				if (apikey == null) {
					return false;
				}
				getPosts(apikey)
			}
		
			lsLogin()
		</script>

  </body>
</html>