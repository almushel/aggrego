<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Aggrego: A Feed Aggregator</title>
  </head>
  <body>
		<h1>Aggrego</h1>
		<div id="logged-out">
			<label for="name-input">Create User:</label>
			<input id="name-input"/>
			<button onclick="createUser()">Create</button>

			<label for="apikey-input">Login with API Key</label>
			<input id="apikey-input"/>
			<button onclick="loginWithKeyInput()">Login</button>
		</div>

		<div id="logged-in" style="display:none">
			<h2 id="current-user">Current user:</h2>
			<button onclick="logout()">Logout</button>

			<h2>Feeds</h2>
			<ul id="user-feeds"></ul>	

			<h2>Posts</h2>
			<div id="posts-container">
			</div>
		</div>

		<style>
			#user-feeds {
				padding: 0;
				list-style-type: none;
			}
		</style>

		<script>
			const lsKeyName = "aggrego-apikey";
			const pageSize = 25;

			async function createUser() {
				const nameInput = document.querySelector("#name-input");

				const requestBody = {
					name: nameInput.value
				};

				const response = await fetch("/v1/users", {
					headers: {
						"Content-Type": "application/json"
					},
					method: "POST",
					body: JSON.stringify(requestBody)
				});

				const rBody = await response.json();

				const success = await login(rBody.apikey);
				if (success) {
					localStorage.setItem(lsKeyName, rBody.apikey);
					nameInput.value = "";
				}
			}
			
			async function login(apikey) {
				const response = await fetch("/v1/users", {
					method: "GET",
					headers: {
						"Authorization": "ApiKey "+apikey
					},
				})
				if (!response.ok) {
					return false;
				}

				const rBody = await response.json();

				document.getElementById("current-user").innerText = "Current user: " + rBody.name;
				document.getElementById("logged-in").style.display = "block";

				document.getElementById("logged-out").style.display = "none";

				updatePosts(apikey);
				updateFeedList(apikey);

				return true;
			}

			async function loginWithKeyInput() {
				const keyInput = document.getElementById("apikey-input");

				const success = await login(keyInput.value)
				if (success) {
					localStorage.setItem(lsKeyName, keyInput.value)
					keyInput.value = ""
				}
			}

			function logout() {
				localStorage.removeItem(lsKeyName)

				document.getElementById("logged-in").style.display = "none";
				document.getElementById("posts-container").textContent = "";
				document.getElementById("logged-out").style.display = "block";
			}

			function loadPage(e) {
				e.preventDefault();
				const page = e.target.href;
				window.history.pushState({}, "", page);
				lsUpdatePosts();
			}
			
			async function getPosts(apikey) {
				const params = new URLSearchParams(window.location.search)
				const page = parseInt(params.get("pg")) || 1

				const offset = (page-1) * pageSize;

				const response = await fetch(`/v1/posts?offset=${offset}&limit=${pageSize}`, {
					method: "GET",
					headers: {
						"Authorization": "ApiKey "+apikey
					}
				});
				const list = await response.json();

				return {
					list,
					page,
					totalCount: response.headers.get("X-Total-Count"),
				}
			}

			async function getFeedFollows(apikey) {
				let response = await fetch("/v1/feed_follows", {
					method: "GET",
					headers: {
						"Authorization": "ApiKey "+apikey
					}
				});

				const result = await response.json();
				return result;

			}

			async function getFeeds() {
				let response = await fetch("/v1/feeds", {
					method: "GET",
				});

				const result = await response.json();
				return result;
			}

			function newPostElement(post) {
				const result = document.createElement("div")
				const url = document.createElement("a");
				url.href=post.url;
				
				const title = document.createElement("h3");
				title.innerText = post.title;

				const description = document.createElement("p");
				description.innerHTML = post.description;

				url.append(title);
				result.append(url, description);
				return result;
			}

			async function updatePosts(apikey) {
				const posts = await getPosts(apikey);
				const container = document.getElementById("posts-container");
				const children = [];
				if (posts.list) {
					for (let post of posts.list) {
						children.push(newPostElement(post))
					}
				} else {
					const notFound = document.createElement("p")
					notFound.textContent = `Page ${posts.page} not found`;
					children.push(notFound);
				}

				const pageCount = Math.ceil(posts.totalCount/pageSize);

				const pages = document.createElement("div");
				pages.style.display = "flex";
				pages.style.justifyContent = "center";
				for (let pg = 1; pg <= pageCount; pg++) {
					const pgLink = document.createElement("a")
					const separator = pg != pageCount ? "," : ""
					if (pg != posts.page) {
						pgLink.addEventListener("click", loadPage);
						pgLink.href = `${window.location.pathname}?pg=${pg}`;
						pgLink.textContent = `  ${pg} ${separator}`;
					} else {
						pgLink.innerHTML = `<strong>  ${pg} ${separator}</strong>`;
					}
					
					pages.append(pgLink);
				}
				children.push(pages);
				container.replaceChildren(...children);
			}

			async function updateFeedList(apikey) {
				const feeds = await getFeeds();
				const follows = await getFeedFollows(apikey);

				const followIDs = []
				follows.forEach(element => {
					followIDs.push(element.feed_id)	
				});

				const feedList = document.getElementById("user-feeds");

				let id = 1
				elements = []
				for (let feed of feeds) {
					const url = new URL(feed.url);

					const e = document.createElement("li");
					e.innerHTML = `<input type="checkbox" ${followIDs.includes(feed.id) ? "checked" : ""}><label for="feed-${id}">${url.hostname}</label>`

					elements.push(e)
				}

				feedList.replaceChildren(...elements)
			}

			async function lsLogin() {
				const apikey = localStorage.getItem(lsKeyName)
				if (apikey == null) {
					return false;
				}
				login(apikey)
			}
			
			async function lsUpdatePosts() {
				const apikey = localStorage.getItem(lsKeyName)
				if (apikey == null) {
					return false;
				}
				updatePosts(apikey)
			}
		
			lsLogin()
		</script>

  </body>
</html>