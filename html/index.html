<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Aggrego: A Feed Aggregator</title>
  </head>
  <body>
		<h1>Aggrego</h1>
		<div id="logged-out">
			<label for="name-input">Create User:</label>
			<input id="name-input"/>
			<button onclick="createUser()">Create</button>

			<label for="apikey-input">Login with API Key</label>
			<input id="apikey-input"/>
			<button onclick="loginWithKey()">Login</button>
		</div>

		<div id="logged-in" style="display:none">
			<h2 id="current-user">Current user:</h2>
			<button onclick="logout()">Logout</button>
		</div>

		<script>
			const lsKeyName = "aggrego-apikey"

			async function createUser() {
				const nameInput = document.querySelector("#name-input");

				requestBody = {
					name: nameInput.value
				};

				response = await fetch("/v1/users", {
					headers: {
						"Content-Type": "application/json"
					},
					method: "POST",
					body: JSON.stringify(requestBody)
				});

				rBody = await response.json();

				localStorage.setItem(lsKeyName, rBody.apikey);

				nameInput.value = "";

				login();
			}

			async function login() {
				const apikey = localStorage.getItem(lsKeyName)
				if (apikey == null) {
					return false;
				}

				response = await fetch("/v1/users", {
					method: "GET",
					headers: {
						"Authorization": "ApiKey "+apikey
					},
				})
				if (!response.ok) {
					return false;
				}

				rBody = await response.json();

				document.getElementById("current-user").innerText = "Current user: " + rBody.name;
				document.getElementById("logged-in").style.display = "block";

				document.getElementById("logged-out").style.display = "none";

				return true;
			}

			async function loginWithKey() {
				keyInput = document.getElementById("apikey-input");
				loginKey = keyInput.value
				if (loginKey.length != 64) {
					alert("login failed")
					return
				}

				localStorage.setItem(lsKeyName, loginKey)
				success = await login()
				if (success) {
					keyInput.value = ""
				} else {
					alert("login failed")
					localStorage.removeItem(lsKeyName)
				}
			}

			function logout() {
				localStorage.removeItem(lsKeyName)

				document.getElementById("logged-in").style.display = "none";
				document.getElementById("logged-out").style.display = "block";

			}
		
			login()
		</script>

  </body>
</html>